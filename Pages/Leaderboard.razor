@page "/leaderboard"
@inject GameProfileService GameProfileService

<h1>Leaderboard</h1>

@if (isLoading)
{
    <div class="d-flex justify-content-center">
        <Spinner Type="SpinnerType.Dots" Color="SpinnerColor.Light" Size="SpinnerSize.ExtraLarge" />
    </div>
}
else
{
    <div class="mt-3">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Rank</th>
                        <th>Username</th>
                        <th>Level</th>
                        <th>Experience</th>
                        <th>Side</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var profile in profiles)
                    {
                        <tr>
                            <td>@profile.Rank</td>
                            <td>@profile.Username</td>
                            <td>@profile.Level</td>
                            <td>@profile.Experience</td>
                            <td>@profile.Side</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private List<GameProfileViewModel> profiles;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        profiles = await LoadLeaderboardAsync();
        isLoading = false;
    }

    private async Task<List<GameProfileViewModel>> LoadLeaderboardAsync()
    {
        await Task.Delay(1000);

        var leaderboard = new List<GameProfileViewModel>();

        try
        {
            var allProfiles = await GameProfileService.SearchProfilesByUsernameAsync("");

            allProfiles = allProfiles.OrderByDescending(p => p.pmc.Level)
                                     .ThenByDescending(p => p.pmc.Experience)
                                     .ToList();

            int rank = 1;
            foreach (var profile in allProfiles)
            {
                leaderboard.Add(new GameProfileViewModel
                    {
                        Rank = rank++,
                        Username = profile.info.username,
                        Level = profile.pmc.Level,
                        Experience = profile.pmc.Experience,
                        Side = profile.pmc.Side
                    });
            }
        }
        catch (Exception ex)
        {
            // Handle exception or logging
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
        }
        return leaderboard;
    }

    public class GameProfileViewModel
    {
        public int Rank { get; set; }
        public string Username { get; set; }
        public int Level { get; set; }
        public int Experience { get; set; }
        public string Side { get; set; }
    }
}
